<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagnostic V2 Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2d;
      --card-alt: #0f1728;
      --panel: #0d1527;
      --text: #e5eefc;
      --muted: #9fb2cc;
      --border: #24334d;

      --primary: #34d399;
      --primary-soft: #0f2f2a;

      --correct: #34d399;
      --correct-bg: #112a22;
      --wrong: #f87171;
      --wrong-bg: #2a1619;

      --radius: 16px;
      --shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.55;
      min-height: 100vh;
      padding: 1.5rem;
    }
    .container { max-width: 760px; margin: 0 auto; }
    a { color: inherit; }
    .back {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      color: var(--muted);
      text-decoration: none;
      font-weight: 800;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .back:hover { color: var(--text); }
    .header {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem 1rem 0.9rem;
      margin-bottom: 1rem;
    }
    .std { font-weight: 800; font-size: 1.15rem; }
    .mapline { color: var(--muted); font-weight: 700; font-size: 0.9rem; margin-top: 0.3rem; }
    .stmt { color: var(--muted); font-weight: 700; font-size: 0.95rem; margin-top: 0.35rem; }
    .progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 0.85rem;
    }
    .bar {
      flex: 1;
      height: 10px;
      background: var(--panel);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(232,226,216,0.9);
    }
    .bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(15,118,110,1), rgba(16,185,129,1));
      transition: width 250ms ease;
    }
    .score { font-weight: 800; color: var(--muted); white-space: nowrap; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
    }
    .qtitle {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.55rem;
    }
    .qtitle h2 { font-size: 1.05rem; font-weight: 800; }
    .qmeta { color: var(--muted); font-weight: 800; font-size: 0.85rem; white-space: nowrap; }
    .stem { font-weight: 700; margin-bottom: 0.8rem; }
    .visual {
      margin: 0.8rem 0;
      padding: 0.8rem;
      border: 1px dashed rgba(232,226,216,1);
      border-radius: 12px;
      background: var(--panel);
      overflow-x: auto;
    }
    .choices { display: grid; gap: 0.6rem; }
    .choice {
      width: 100%;
      text-align: left;
      border: 1px solid var(--border);
      background: var(--card-alt);
      border-radius: 14px;
      padding: 0.75rem 0.8rem;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(45,42,36,0.03);
      transition: transform 120ms ease, border-color 120ms ease;
      font-weight: 800;
      display: flex;
      gap: 0.7rem;
      align-items: flex-start;
    }
    .choice:hover { transform: translateY(-1px); border-color: rgba(15,118,110,0.25); }
    .choice[disabled] { cursor: default; opacity: 0.95; transform: none; }
    .badge {
      flex: 0 0 auto;
      width: 28px;
      height: 28px;
      border-radius: 9px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      background: var(--panel);
      border: 1px solid rgba(232,226,216,1);
      color: var(--text);
    }
    .choice.correct {
      border-color: rgba(13,148,136,0.35);
      background: var(--correct-bg);
    }
    .choice.correct .badge {
      background: rgba(13,148,136,0.12);
      border-color: rgba(13,148,136,0.35);
      color: var(--correct);
    }
    .choice.wrong {
      border-color: rgba(194,65,12,0.35);
      background: var(--wrong-bg);
    }
    .choice.wrong .badge {
      background: rgba(194,65,12,0.12);
      border-color: rgba(194,65,12,0.35);
      color: var(--wrong);
    }
    .choice .txt { font-weight: 800; }

    .feedback {
      margin-top: 0.9rem;
      padding: 0.85rem;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
    }
    .feedback .label {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 900;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--primary);
      background: var(--primary-soft);
      border: 1px solid rgba(15,118,110,0.16);
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
    }
    .feedback p { margin-top: 0.55rem; font-weight: 800; }
    .feedback .mis { color: var(--wrong); }

    .footer {
      margin-top: 1rem;
      display: flex;
      gap: 0.8rem;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(15,118,110,0.22);
      background: var(--primary);
      color: white;
      font-weight: 900;
      font-size: 0.92rem;
      padding: 0.6rem 0.85rem;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 110px;
    }
    .btn.secondary {
      background: var(--card-alt);
      color: var(--text);
      border-color: rgba(232,226,216,1);
    }
    .btn:focus { outline: 3px solid rgba(15,118,110,0.25); outline-offset: 2px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="index.html">← Back to CC standards</a>

    <div id="header" class="header">
      <div class="std" id="std">Loading…</div>
      <div class="mapline" id="mapline"></div>
      <div class="stmt" id="stmt"></div>
      <div class="progress">
        <div class="bar" aria-label="progress"><div id="barFill"></div></div>
        <div class="score" id="score">0/0</div>
      </div>
    </div>

    <div id="card" class="card hidden">
      <div class="qtitle">
        <h2 id="qTitle">Question</h2>
        <div class="qmeta" id="qMeta"></div>
      </div>
      <div class="stem" id="stem"></div>
      <div class="visual hidden" id="visual"></div>

      <div class="choices" id="choices"></div>

      <div class="feedback hidden" id="feedback">
        <span class="label">Explanation</span>
        <p id="explain"></p>
        <p class="mis hidden" id="miscon"></p>
      </div>

      <div class="footer">
        <a class="btn secondary" id="restart" href="#">Restart</a>
        <button class="btn" id="next">Next</button>
      </div>
    </div>

    <div id="error" class="card hidden" role="alert"></div>
  </div>

  <script src="data.js"></script>
  <script>
    (function () {
      function qs(name) { return new URLSearchParams(window.location.search).get(name); }
      function safeText(s) { return (s == null) ? '' : String(s); }
      function byId(id) { return document.getElementById(id); }

      var headerStd = byId('std');
      var headerMap = byId('mapline');
      var headerStmt = byId('stmt');
      var barFill = byId('barFill');
      var scoreEl = byId('score');

      var card = byId('card');
      var error = byId('error');

      var qTitle = byId('qTitle');
      var qMeta = byId('qMeta');
      var stemEl = byId('stem');
      var visualEl = byId('visual');
      var choicesEl = byId('choices');
      var feedbackEl = byId('feedback');
      var explainEl = byId('explain');
      var misconEl = byId('miscon');

      var nextBtn = byId('next');
      var restartA = byId('restart');

      var data = (typeof DIAGNOSTIC_V2_DATA !== 'undefined') ? DIAGNOSTIC_V2_DATA : null;
      var standards = data && Array.isArray(data.standards) ? data.standards : [];

      var stdId = qs('standard_id') || qs('standard') || '';
      stdId = safeText(stdId).trim();

      function fail(msg) {
        card.classList.add('hidden');
        error.classList.remove('hidden');
        error.textContent = msg;
        headerStd.textContent = 'Diagnostic V2';
        headerMap.textContent = '';
        headerStmt.textContent = '';
      }

      if (!standards.length) {
        fail('No DIAGNOSTIC_V2_DATA found. Did you build data.js?');
        return;
      }
      if (!stdId) {
        fail('Missing ?standard_id=... in the URL. Go back and pick a CC standard.');
        return;
      }

      var standard = null;
      for (var i = 0; i < standards.length; i++) {
        if (safeText(standards[i].standard_id) === stdId) { standard = standards[i]; break; }
      }
      if (!standard) {
        fail('Standard not found: ' + stdId);
        return;
      }

      var questions = Array.isArray(standard.questions) ? standard.questions : [];
      if (!questions.length) {
        fail('No questions found for: ' + stdId);
        return;
      }

      headerStd.textContent = 'CC Standard ' + stdId + ' (' + questions.length + 'Q)';
      headerMap.textContent = safeText(standard.module) + ' | Topic ' + safeText(standard.topic_id) + ' - ' + safeText(standard.topic_title);
      headerStmt.textContent = safeText(standard.standard_statement);

      var idx = 0;
      var score = 0;
      var answered = false;

      function updateHeader() {
        var pct = Math.round(((idx) / questions.length) * 100);
        barFill.style.width = pct + '%';
        scoreEl.textContent = score + '/' + questions.length;
      }

      function renderQuestion() {
        answered = false;
        feedbackEl.classList.add('hidden');
        explainEl.textContent = '';
        misconEl.textContent = '';
        misconEl.classList.add('hidden');

        var q = questions[idx];
        qTitle.textContent = 'Question ' + (idx + 1) + ' of ' + questions.length;
        qMeta.textContent = (q && q.id) ? safeText(q.id) : '';
        stemEl.textContent = safeText(q && q.stem);

        var vh = (q && typeof q.visual_html === 'string') ? q.visual_html : '';
        if (vh && vh.trim()) {
          visualEl.classList.remove('hidden');
          visualEl.innerHTML = vh;
        } else {
          visualEl.classList.add('hidden');
          visualEl.innerHTML = '';
        }

        choicesEl.innerHTML = '';
        var choices = (q && Array.isArray(q.choices)) ? q.choices : [];
        for (var i = 0; i < choices.length; i++) {
          (function (choice) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'choice';
            btn.innerHTML =
              '<span class="badge">' + safeText(choice.label) + '</span>' +
              '<span class="txt">' + safeText(choice.text) + '</span>';
            btn.addEventListener('click', function () { onPick(btn, choice); });
            choicesEl.appendChild(btn);
          })(choices[i]);
        }

        nextBtn.textContent = (idx === questions.length - 1) ? 'Finish' : 'Next';
        updateHeader();
        card.classList.remove('hidden');
      }

      function lockChoices() {
        var nodes = choicesEl.querySelectorAll('button.choice');
        for (var i = 0; i < nodes.length; i++) nodes[i].disabled = true;
      }

      function onPick(btn, choice) {
        if (answered) return;
        answered = true;

        var q = questions[idx];
        var isCorrect = !!(choice && choice.correct === true);

        lockChoices();

        // Mark all choices after selection.
        var nodes = choicesEl.querySelectorAll('button.choice');
        var choices = (q && Array.isArray(q.choices)) ? q.choices : [];
        for (var i = 0; i < nodes.length; i++) {
          var c = choices[i];
          if (!c) continue;
          if (c.correct === true) nodes[i].classList.add('correct');
        }
        if (!isCorrect) btn.classList.add('wrong');

        if (isCorrect) score++;

        feedbackEl.classList.remove('hidden');
        explainEl.textContent = safeText(q && q.explanation);
        var mis = (!isCorrect && choice && choice.misconception) ? safeText(choice.misconception) : '';
        if (mis.trim()) {
          misconEl.textContent = mis;
          misconEl.classList.remove('hidden');
        }

        updateHeader();
      }

      function finish() {
        barFill.style.width = '100%';
        qTitle.textContent = 'Finished';
        qMeta.textContent = '';
        stemEl.textContent = 'Score: ' + score + ' / ' + questions.length;
        visualEl.classList.add('hidden');
        visualEl.innerHTML = '';
        choicesEl.innerHTML = '';
        feedbackEl.classList.add('hidden');
        nextBtn.disabled = true;
        nextBtn.textContent = 'Done';
      }

      nextBtn.addEventListener('click', function () {
        if (!answered) return; // answer required
        if (idx >= questions.length - 1) {
          finish();
          return;
        }
        idx++;
        renderQuestion();
      });

      restartA.addEventListener('click', function (e) {
        e.preventDefault();
        idx = 0;
        score = 0;
        nextBtn.disabled = false;
        renderQuestion();
      });

      renderQuestion();
    })();
  </script>
</body>
</html>
