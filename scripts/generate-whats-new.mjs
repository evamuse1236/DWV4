#!/usr/bin/env node
import { execSync } from "node:child_process";
import { mkdirSync, writeFileSync } from "node:fs";
import { dirname, resolve } from "node:path";

const DEFAULT_LIMIT = 30;
const LIMIT = Number(process.env.WHATS_NEW_LIMIT || DEFAULT_LIMIT);
const OUTPUT_PATH = resolve(process.cwd(), "src/data/whatsNew.generated.ts");

function parseGitLog(raw) {
  return raw
    .split("\x1e")
    .map((row) => row.trim())
    .filter(Boolean)
    .map((row) => {
      const [hash = "", date = "", subject = "", body = ""] = row.split("\x1f");
      return {
        hash: hash.trim(),
        sortDate: date.trim(),
        title: subject.trim(),
        body: body.trim(),
      };
    })
    .filter((entry) => entry.sortDate && entry.title);
}

function toDisplayDate(sortDate) {
  const [year, month, day] = sortDate.split("-").map(Number);
  if (!year || !month || !day) return sortDate;
  const dt = new Date(Date.UTC(year, month - 1, day));
  return dt.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    timeZone: "UTC",
  });
}

function toDescription(body, hash) {
  const firstBodyLine = body
    .split("\n")
    .map((line) => line.trim())
    .find((line) => line.length > 0);
  if (firstBodyLine) return firstBodyLine;
  return `Code updates shipped in commit ${hash.slice(0, 7)}.`;
}

function escapeText(value) {
  return value.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
}

function loadEntries() {
  try {
    const raw = execSync(
      `git log -n ${LIMIT} --date=short --pretty=format:%H%x1f%ad%x1f%s%x1f%b%x1e`,
      { encoding: "utf8", stdio: ["ignore", "pipe", "ignore"] }
    );
    return parseGitLog(raw).map((entry) => ({
      date: toDisplayDate(entry.sortDate),
      sortDate: entry.sortDate,
      title: entry.title,
      description: toDescription(entry.body, entry.hash),
    }));
  } catch {
    return [];
  }
}

function buildSource(entries) {
  const lines = [
    "/* eslint-disable */",
    "// Auto-generated by scripts/generate-whats-new.mjs",
    "// Do not edit manually.",
    "",
    "export interface WhatsNewEntry {",
    "  date: string;",
    "  sortDate: string;",
    "  title: string;",
    "  description: string;",
    "}",
    "",
    "export const WHATS_NEW: WhatsNewEntry[] = [",
  ];

  for (const entry of entries) {
    lines.push("  {");
    lines.push(`    date: "${escapeText(entry.date)}",`);
    lines.push(`    sortDate: "${escapeText(entry.sortDate)}",`);
    lines.push(`    title: "${escapeText(entry.title)}",`);
    lines.push(`    description: "${escapeText(entry.description)}",`);
    lines.push("  },");
  }

  lines.push("];");
  lines.push("");
  lines.push("export default WHATS_NEW;");
  lines.push("");
  return lines.join("\n");
}

const entries = loadEntries();
mkdirSync(dirname(OUTPUT_PATH), { recursive: true });
writeFileSync(OUTPUT_PATH, buildSource(entries), "utf8");

console.log(`Generated ${entries.length} What's New entries at ${OUTPUT_PATH}`);
